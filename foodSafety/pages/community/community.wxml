<!-- pages/community/community.wxml -->
<view class="community-page">
  <!-- 顶部栏 -->
  <view class="header-bar">
    <view class="header-title">
      <text class="title-text">食安社区</text>
      <text class="title-sub">分享食品安全经验</text>
    </view>
    <button 
        class="my-posts-btn" 
        bindtap="viewMyPosts"
        wx:if="{{isLoggedIn}}"
      >
        我的
      </button>

  </view>

  <!-- 排序标签 -->
  <view class="sort-tabs">
    <view 
      wx:for="{{sortOptions}}" 
      wx:key="value"
      class="sort-tab {{sortBy === item.value ? 'active' : ''}}"
      bindtap="switchSort"
      data-sort="{{item.value}}"
    >
      <icon type="{{item.icon}}" size="14" />
      <text class="tab-text">{{item.label}}</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading && posts.length === 0}}">
    <view class="loading-content">
      <view class="mini-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-overlay" wx:if="{{!loading && empty}}">
    <view class="empty-content">
      <icon type="chat" size="80" color="#bdc3c7" />
      <text class="empty-text">{{emptyMessage}}</text>
      <text class="empty-subtext">{{emptySubMessage}}</text>
      <button class="empty-action" bindtap="createNewPost">
        <icon type="add" size="16" />
        发布第一条内容
      </button>
    </view>
  </view>

  <!-- 帖子列表 -->
  <scroll-view 
    class="post-list" 
    scroll-y 
    wx:if="{{!loading && !empty}}"
    refresher-enabled="true"
    refresher-triggered="{{false}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
  >
    <block wx:for="{{posts}}" wx:key="id">
      <view class="post-card" bindtap="navigateToPostDetail" data-id="{{item.id}}">
        <!-- 用户信息 -->
        <view class="user-info">
          <image class="user-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" />
          <view class="user-details">
            <text class="user-name">{{item.userNickname || '匿名用户'}}</text>
            <text class="post-time">{{item.displayTime || '刚刚'}}</text>
          </view>
        </view>

        <!-- 标题 -->
        <view class="post-title" wx:if="{{item.title}}">
          <text class="title-text">{{item.title}}</text>
        </view>

        <!-- 内容 -->
        <view class="post-content">
          <text class="content-text">{{item.content}}</text>
        </view>

        <!-- 图片 -->
        <view class="post-images" wx:if="{{item.hasImages && item.images.length > 0}}">
          <view 
            wx:for="{{item.images}}" 
            wx:key="index"
            wx:for-item="img"
            class="image-item"
            data-index="{{index}}"
            data-images="{{item.images}}"
            bindtap="previewImage"
            catchtap="true" 
          >
            <image class="post-image" src="{{img}}" mode="aspectFill" />
          </view>
        </view>

        <!-- 操作栏 -->
        <view class="post-actions">
          <!-- 点赞 -->
          <view 
            class="action-item {{item.isLiked ? 'liked' : ''}}"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="toggleLike"
            catchtap="true"
          >
            <image 
              src="{{item.isLiked ? '/assets/icons/liked.png' : '/assets/icons/like.png'}}" 
              style="width: 32rpx; height: 32rpx;"
            />
            <text class="action-count">{{item.likeCount || 0}}</text>
          </view>

          <!-- 评论 -->
          <view 
            class="action-item"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="viewComments"
            catchtap="true" 
          >
            <image 
              src="/assets/icons/comment.png" 
              style="width: 32rpx; height: 32rpx;"
            />
            <text class="action-count">{{item.commentCount || 0}}</text>
          </view>

          <!-- 查看次数 -->
          <view 
            class="action-item"
            data-id="{{item.id}}"
            data-index="{{index}}"
            catchtap="true" 
          >
            <image 
              src="/assets/icons/view.png" 
              style="width: 32rpx; height: 32rpx;"
            />
            <text class="action-count">{{item.viewCount || 0}}</text>
          </view>

          <!-- 分享 -->
          <view 
            class="action-item"
            data-id="{{item.id}}"
            data-index="{{index}}"
          >
            <image 
              src="/assets/icons/share.png" 
              style="width: 32rpx; height: 32rpx;"
            />
            <text class="action-count">{{item.shareCount || 0}}</text>
          </view>
        </view>
      </view>

      <!-- 评论列表区域 -->
      <view class="comment-section" wx:if="{{showComments && currentPostId === item.id}}">
        <!-- 评论加载中 -->
        <view class="loading-comments" wx:if="{{loadingComments}}">
          <view class="mini-spinner"></view>
          <text class="loading-text">加载评论中...</text>
        </view>

        <!-- 评论列表 -->
        <view class="comment-list" wx:else>
          <block wx:for="{{comments}}" wx:key="id">
            <view class="comment-item">
              <image class="comment-avatar" src="{{item.userAvatar || '/assets/images/default-avatar.png'}}" />
              <view class="comment-content-wrap">
                <text class="comment-username">{{item.userNickname || '匿名用户'}}</text>
                <text class="comment-text">{{item.content}}</text>
                <text class="comment-time">{{item.createTime || '刚刚'}}</text>
              </view>
            </view>
          </block>

          <!-- 空评论提示 -->
          <view class="empty-comment" wx:if="{{comments.length === 0}}">
            <text class="empty-comment-text">暂无评论，快来抢沙发~</text>
          </view>

          <!-- 加载更多评论 -->
          <view class="load-more-comment" wx:if="{{hasMoreComments}}">
            <text class="load-text" wx:if="{{!loadingMoreComments}}" bindtap="loadMoreComments">点击加载更多</text>
            <view class="loading-more" wx:if="{{loadingMoreComments}}">
              <view class="mini-spinner"></view>
              <text>加载中...</text>
            </view>
          </view>
        </view>

        <!-- 评论输入框 -->
        <view class="comment-input-wrap" wx:if="{{showCommentInput && currentPostId === item.id}}">
          <input 
            class="comment-input" 
            placeholder="请输入评论内容..." 
            value="{{commentContent}}"
            bindinput="onCommentInput"
          />
          <button class="comment-submit-btn" bindtap="submitComment">发布</button>
          <button class="comment-cancel-btn" bindtap="hideCommentInput">取消</button>
        </view>

        <!-- 显示评论输入按钮 -->
        <view class="comment-add-btn-wrap" wx:if="{{!showCommentInput && showComments && currentPostId === item.id}}">
          <button class="comment-add-btn" bindtap="showCommentInput" data-id="{{item.id}}" data-index="{{index}}">
            发表评论
          </button>
        </view>
      </view>
    </block>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore}}">
      <text class="load-text" wx:if="{{!loadingMore}}">上拉加载更多</text>
      <view class="loading-more" wx:if="{{loadingMore}}">
        <view class="mini-spinner"></view>
        <text>加载中...</text>
      </view>
    </view>

    <!-- 底部空白 -->
    <view class="bottom-space" style="height: 120rpx;"></view>
  </scroll-view>

  <!-- 发布按钮（悬浮） -->
  <view class="float-action-btn" bindtap="createNewPost">
    <image src="/assets/icons/add.png" class="add-icon" mode="aspectFit" />
  </view>
</view>