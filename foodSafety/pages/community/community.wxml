<!-- pages/community/community.wxml -->
<view class="community-page">
  <!-- 顶部栏 -->
  <view class="header-bar">
    <view class="header-title">
      <text class="title-text">食安社区</text>
      <text class="title-sub">分享食品安全经验</text>
    </view>
    <button class="publish-btn" bindtap="createNewPost">
      <icon type="add" size="18" />
      发布
    </button>
  </view>

  <!-- 排序标签 -->
  <view class="sort-tabs">
    <view 
      wx:for="{{sortOptions}}" 
      wx:key="value"
      class="sort-tab {{sortBy === item.value ? 'active' : ''}}"
      bindtap="switchSort"
      data-sort="{{item.value}}"
    >
      <icon type="{{item.icon}}" size="14" />
      <text class="tab-text">{{item.label}}</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading && posts.length === 0}}">
    <view class="loading-content">
      <view class="spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-overlay" wx:if="{{!loading && empty}}">
    <view class="empty-content">
      <icon type="chat" size="80" color="#bdc3c7" />
      <text class="empty-text">{{emptyMessage}}</text>
      <text class="empty-subtext">{{emptySubMessage}}</text>
      <button class="empty-action" bindtap="createNewPost">
        <icon type="add" size="16" />
        发布第一条内容
      </button>
    </view>
  </view>

  <!-- 帖子列表 -->
  <scroll-view 
    class="post-list" 
    scroll-y 
    wx:if="{{!loading && !empty}}"
    refresher-enabled="true"
    refresher-triggered="{{false}}"
    bindrefresherrefresh="onPullDownRefresh"
  >
    <block wx:for="{{posts}}" wx:key="id">
      <view class="post-card">
        <!-- 用户信息 -->
        <view class="user-info">
          <image class="user-avatar" src="{{item.userAvatar}}" />
          <view class="user-details">
            <text class="user-name">{{item.userNickname}}</text>
            <text class="post-time">{{item.displayTime}}</text>
          </view>
        </view>

        <!-- 标题 -->
        <view class="post-title" wx:if="{{item.title}}">
          <text class="title-text">{{item.title}}</text>
        </view>

        <!-- 内容 -->
        <view class="post-content">
          <text class="content-text">{{item.content}}</text>
        </view>

        <!-- 图片 -->
        <view class="post-images" wx:if="{{item.hasImages}}">
          <view 
            wx:for="{{item.images}}" 
            wx:key="index"
            class="image-item"
            data-index="{{index}}"
            data-images="{{item.images}}"
            bindtap="previewImage"
          >
            <image class="post-image" src="{{item}}" mode="aspectFill" />
          </view>
        </view>

        <!-- 操作栏 -->
        <view class="post-actions">
          <!-- 点赞 -->
          <view 
            class="action-item {{item.isLiked ? 'liked' : ''}}"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="toggleLike"
          >
          <image 
              src="{{item.isLiked ? '/assets/icons/liked.png' : '/assets/icons/like.png'}}" 
              style="width: 20px; height: 20px;"
            />
            <text class="action-count">{{item.likeCount || 0}}</text>
          </view>

          <!-- 评论 -->
          <view class="action-item">
            <image 
              src="{{'/assets/icons/comment.png'}}" 
              style="width: 20px; height: 20px;"
            />
            <text class="action-count">{{item.commentCount || 0}}</text>
          </view>

          <!-- 分享 -->
          <view class="action-item">
            <icon type="share" size="20" />
          </view>

          <!-- 复制 -->
          <view 
            class="action-item"
            data-content="{{item.content}}"
            bindtap="copyContent"
          >
            <icon type="copy" size="20" />
          </view>
        </view>
      </view>
    </block>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore}}">
      <text class="load-text" wx:if="{{!loadingMore}}">上拉加载更多</text>
      <view class="loading-more" wx:if="{{loadingMore}}">
        <view class="mini-spinner"></view>
        <text>加载中...</text>
      </view>
    </view>

    <!-- 底部空白 -->
    <view class="bottom-space"></view>
  </scroll-view>

  <!-- 发布按钮（悬浮） -->
  <view class="float-action-btn" bindtap="createNewPost">
    <icon type="add" size="24" color="#fff" />
  </view>
</view>