<!-- pages/inventory/inventory.wxml -->
<view class="inventory-page">
  
  <!-- 自定义导航栏 -->
  <custom-navbar title="我的冰箱" background="#4CAF50" color="#fff" 
                 left-icon="home" right-icon="scan" 
                 bind:righttap="quickScanAdd">
    <view slot="right" class="navbar-right">
      <text class="iconfont icon-scan"></text>
    </view>
  </custom-navbar>
  
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
  </view>
  
  <!-- 错误状态 -->
  <view wx:if="{{error && !loading}}" class="error-container">
    <view class="error-content">
      <image src="/assets/images/error.png" class="error-icon"></image>
      <text class="error-text">{{errorMsg || '加载失败'}}</text>
      <button class="retry-btn" bindtap="onRetryLoad">重试</button>
    </view>
  </view>
  
  <!-- 主要内容区域 -->
  <view wx:if="{{!loading && !error}}" class="main-content">
    
    <!-- 统计卡片 -->
    <view class="stats-section">
      <view class="stats-card">
        <view class="stats-header">
          <text class="stats-title">冰箱概览</text>
          <text class="stats-refresh iconfont icon-refresh" bindtap="onRefresh"></text>
        </view>
        
        <view class="stats-grid">
          <view class="stat-item {{stats.total > 0 ? 'active' : ''}}">
            <text class="stat-number">{{stats.total}}</text>
            <text class="stat-label">总数</text>
          </view>
          
          <view class="stat-item fresh {{stats.fresh > 0 ? 'active' : ''}}">
            <text class="stat-number">{{stats.fresh}}</text>
            <text class="stat-label">新鲜</text>
          </view>
          
          <view class="stat-item expiring {{stats.expiring > 0 ? 'active' : ''}}">
            <text class="stat-number">{{stats.expiring}}</text>
            <text class="stat-label">临期</text>
          </view>
          
          <view class="stat-item expired {{stats.expired > 0 ? 'active' : ''}}">
            <text class="stat-number">{{stats.expired}}</text>
            <text class="stat-label">过期</text>
          </view>
        </view>
        
        <view wx:if="{{stats.expiringSoon > 0}}" class="warning-tip">
          <text class="iconfont icon-warning"></text>
          <text>有 {{stats.expiringSoon}} 个商品将在3天内过期！</text>
        </view>
      </view>
    </view>
    
    <!-- 筛选标签 -->
    <view class="filter-section">
      <scroll-view class="filter-scroll" scroll-x="true" enable-flex>
        <view class="filter-tags">
          <block wx:for="{{filterOptions}}" wx:key="id">
            <view 
              class="filter-tag {{filterStatus === item.id ? 'active' : ''}}" 
              bindtap="switchFilter" 
              data-status="{{item.id}}">
              <text class="filter-tag-name">{{item.name}}</text>
              <text class="filter-tag-count {{item.count > 0 ? 'has-count' : ''}}">
                {{item.count}}
              </text>
            </view>
          </block>
        </view>
      </scroll-view>
    </view>
    
    <!-- 空状态 -->
    <view wx:if="{{empty && !loading}}" class="empty-container">
      <view class="empty-content">
        <image src="/assets/images/empty-fridge.png" class="empty-icon"></image>
        <text class="empty-text">{{emptyMessage}}</text>
        <text class="empty-subtext">{{emptySubMessage}}</text>
        <view class="empty-buttons">
          <button class="primary-btn" bindtap="quickScanAdd">
            <text class="iconfont icon-scan"></text>
            <text>扫码添加</text>
          </button>
          <button class="secondary-btn" bindtap="viewExpirySuggestions">
            <text class="iconfont icon-tips"></text>
            <text>查看建议</text>
          </button>
        </view>
      </view>
    </view>
    
    <!-- 库存列表 -->
    <view wx:if="{{!empty}}" class="inventory-list-section">
      <view class="section-header">
        <text class="section-title">
          {{filterStatus === null ? '全部商品' : 
            filterStatus === 1 ? '新鲜商品' :
            filterStatus === 2 ? '临期商品' : '过期商品'}}
          ({{filteredList.length}})
        </text>
        <text wx:if="{{filterStatus === 3 && filteredList.length > 0}}" 
              class="batch-delete" bindtap="batchDeleteExpired">
          <text class="iconfont icon-delete"></text>
          一键清理
        </text>
      </view>
      
      <scroll-view class="inventory-list" scroll-y="true" enable-back-to-top>
        <block wx:for="{{filteredList}}" wx:key="id">
          <view class="inventory-item {{item.status === 3 ? 'expired' : item.status === 2 ? 'expiring' : ''}}">
            <view class="item-main" bindtap="viewProductDetail" data-item="{{item}}">
              <!-- 商品图片 -->
              <view class="item-image">
                <image 
                  src="{{item.image || '/assets/images/default-food.png'}}" 
                  mode="aspectFill"
                  lazy-load="true"
                  class="product-image"
                ></image>
                <view class="status-badge status-{{item.status}}">
                  <text class="iconfont {{item.statusIcon || 'icon-fresh'}}"></text>
                </view>
              </view>
              
              <!-- 商品信息 -->
              <view class="item-info">
                <view class="item-header">
                  <text class="product-name">{{item.productName || '未知商品'}}</text>
                  <text class="days-left {{item.status === 3 ? 'danger' : item.status === 2 ? 'warning' : 'safe'}}">
                    {{item.daysText || ''}}
                  </text>
                </view>
                
                <view class="item-meta">
                  <text class="expiry-date">
                    <text class="iconfont icon-calendar"></text>
                    过期: {{item.displayDate || '未设置'}}
                  </text>
                  <text wx:if="{{item.purchaseDate}}" class="purchase-date">
                    <text class="iconfont icon-shopping"></text>
                    购买: {{item.purchaseDate}}
                  </text>
                </view>
                
                <view class="item-status">
                  <text class="status-text" style="color: {{item.statusColor}};">
                    {{item.statusText || '新鲜'}}
                  </text>
                  <text class="status-msg">{{item.statusMsg || ''}}</text>
                </view>
              </view>
            </view>
            
            <!-- 操作按钮 -->
            <view class="item-actions">
              <button class="action-btn edit" bindtap="editInventoryItem" data-item="{{item}}">
                <text class="iconfont icon-edit"></text>
                <text>编辑</text>
              </button>
              <button class="action-btn delete" bindtap="confirmDelete" 
                      data-id="{{item.id}}" data-name="{{item.productName}}">
                <text class="iconfont icon-delete"></text>
                <text>移除</text>
              </button>
            </view>
          </view>
        </block>
      </scroll-view>
    </view>
  </view>
  
  <!-- 悬浮按钮 -->
  <view class="floating-buttons">
    <button class="fab primary-fab" bindtap="quickScanAdd">
      <text class="iconfont icon-add"></text>
      <text class="fab-text">扫码添加</text>
    </button>
  </view>
  
  <!-- 编辑弹窗 -->
  <view wx:if="{{showEditModal}}" class="modal-overlay">
    <view class="modal-content edit-modal">
      <view class="modal-header">
        <text class="modal-title">编辑商品信息</text>
        <text class="iconfont icon-close" bindtap="closeEditModal"></text>
      </view>
      
      <view class="modal-body">
        <view class="product-preview">
          <image 
            src="{{editingItem.image || '/assets/images/default-food.png'}}" 
            class="preview-image"
          ></image>
          <text class="preview-name">{{editingItem.productName || '商品'}}</text>
        </view>
        
        <form class="edit-form">
        <!-- 购买日期 -->
        <view class="form-item">
          <text class="form-label">购买日期</text>
          <view class="form-input-container">
            <view 
              class="form-input {{editForm.purchaseDate ? 'has-value' : ''}}" 
              bindtap="showDatePicker" 
              data-field="purchaseDate">
              {{editForm.purchaseDate || '请选择购买日期'}}
              <text class="iconfont icon-calendar"></text>
            </view>
            <view wx:if="{{editForm.purchaseDate}}" class="form-input-clear" bindtap="clearDate" data-field="purchaseDate">
              <text class="iconfont icon-close"></text>
            </view>
          </view>
        </view>
        
        <!-- 过期日期 -->
        <view class="form-item required">
          <text class="form-label">过期日期</text>
          <view class="form-input-container">
            <view 
              class="form-input {{editForm.expiryDate ? 'has-value' : ''}}" 
              bindtap="showDatePicker" 
              data-field="expiryDate">
              {{editForm.expiryDate || '请选择过期日期'}}
              <text class="iconfont icon-calendar"></text>
            </view>
            <view wx:if="{{editForm.expiryDate}}" class="form-input-clear" bindtap="clearDate" data-field="expiryDate">
              <text class="iconfont icon-close"></text>
            </view>
          </view>
        </view>
        
        <!-- 日期提醒 -->
        <view wx:if="{{editForm.expiryDate && editForm.purchaseDate}}" class="date-info">
          <text class="iconfont icon-tips"></text>
          <text>购买后保存时间：{{calculateDaysBetween(editForm.purchaseDate, editForm.expiryDate)}}天</text>
        </view>
        
        <!-- 过期提示 -->
        <view wx:if="{{editForm.expiryDate && isDateExpired(editForm.expiryDate)}}" class="warning-info">
          <text class="iconfont icon-warning"></text>
          <text>注意：此日期已过期</text>
        </view>
      </form>
      </view>
      
      <view class="modal-footer">
        <button class="btn cancel" bindtap="closeEditModal">取消</button>
        <button class="btn confirm {{editLoading ? 'loading' : ''}}" bindtap="saveEdit" disabled="{{editLoading}}">
          <text wx:if="{{editLoading}}" class="loading-spinner"></text>
          {{editLoading ? '保存中...' : '保存'}}
        </button>
      </view>
    </view>
  </view>
  
  <!-- 删除确认弹窗 -->
  <view wx:if="{{showDeleteConfirm}}" class="modal-overlay">
    <view class="modal-content delete-modal">
      <view class="modal-header">
        <text class="modal-title">确认移除</text>
        <text class="iconfont icon-close" bindtap="closeDeleteConfirm"></text>
      </view>
      
      <view class="modal-body">
        <view class="delete-icon">
          <text class="iconfont icon-warning"></text>
        </view>
        <text class="delete-message">{{deleteConfirmMessage}}</text>
        <text class="delete-tip">移除后该商品将从冰箱中删除</text>
      </view>
      
      <view class="modal-footer">
        <button class="btn cancel" bindtap="closeDeleteConfirm">取消</button>
        <button class="btn danger confirm" bindtap="executeDelete">确认移除</button>
      </view>
    </view>
  </view>
  
  <!-- 底部操作栏 -->
  <view class="bottom-actions">
    <button class="action-button" bindtap="viewExpirySuggestions">
      <text class="iconfont icon-tips"></text>
      <text>管理建议</text>
    </button>
    <button class="action-button primary" bindtap="addNewItem">
      <text class="iconfont icon-plus"></text>
      <text>添加商品</text>
    </button>
    <button class="action-button" bindtap="onShareAppMessage" open-type="share">
      <text class="iconfont icon-share"></text>
      <text>分享</text>
    </button>
  </view>
</view>

<!-- 日期选择器弹窗 -->
<view wx:if="{{datePickerVisible}}" class="modal-overlay">
  <view class="modal-content date-picker-modal">
    <view class="modal-header">
      <text class="modal-title">{{datePickerTitle}}</text>
      <text class="iconfont icon-close" bindtap="closeDatePicker"></text>
    </view>
    
    <view class="modal-body">
      <!-- 快速设置按钮 -->
      <view class="quick-date-buttons">
        <view class="quick-date-row">
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="today">今天</button>
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="tomorrow">明天</button>
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="3days">3天后</button>
        </view>
        <view class="quick-date-row">
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="week">一周后</button>
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="month">一月后</button>
          <button class="quick-date-btn" bindtap="quickSetDate" data-type="custom">自定义</button>
        </view>
      </view>
      
      <!-- 日期选择器 -->
      <picker 
        mode="date" 
        value="{{datePickerValue}}" 
        start="{{minDate}}" 
        end="{{maxDate}}"
        bindchange="onDatePickerChange"
        class="date-picker">
        <view class="date-picker-display">
          <text class="selected-date">{{datePickerValue || '请选择日期'}}</text>
          <text class="iconfont icon-arrow-down"></text>
        </view>
      </picker>
      
      <!-- 日期预览 -->
      <view wx:if="{{datePickerValue}}" class="date-preview">
        <text class="preview-text">
          {{formatDateDisplay(datePickerValue)}}
        </text>
        <text class="preview-days" wx:if="{{currentDateField === 'expiryDate' && editForm.purchaseDate}}">
          还有 {{calculateDaysBetween(editForm.purchaseDate, datePickerValue)}} 天
        </text>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn cancel" bindtap="closeDatePicker">取消</button>
      <button class="btn confirm" bindtap="confirmDatePicker">确定</button>
    </view>
  </view>
</view>