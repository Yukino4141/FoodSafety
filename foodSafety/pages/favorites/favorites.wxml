<!-- pages/favorites/favorites.wxml -->
<view class="favorites-page">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="navbar">
    <view class="nav-left">
      <text class="nav-title" wx:if="{{!editing}}">æˆ‘çš„æ”¶è—</text>
      <text class="nav-title" wx:else>é€‰æ‹©æ”¶è—</text>
    </view>
    <view class="nav-right">
      <view class="edit-btn" bindtap="toggleEditMode" wx:if="{{!empty}}">
        <text>{{editing ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading && !loadingMore}}">
    <view class="loading-content">
      <image src="/assets/images/loading.gif" class="loading-icon" />
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{error && !loading}}">
    <view class="error-content">
      <image src="/assets/images/error.png" class="error-icon" />
      <text class="error-text">{{errorMsg}}</text>
      <button class="retry-btn" bindtap="reload">é‡æ–°åŠ è½½</button>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-container" wx:if="{{empty && !loading && !error}}">
    <view class="empty-content">
      <image src="/assets/images/empty-favorites.png" class="empty-icon" />
      <text class="empty-text">æš‚æ— æ”¶è—å•†å“</text>
      <text class="empty-hint">æ‰«æå•†å“åå¯ä»¥ç‚¹å‡»æ”¶è—æŒ‰é’®å“¦</text>
      <button class="scan-btn" bindtap="goToScan">å»æ‰«æå•†å“</button>
    </view>
  </view>

  <!-- æ”¶è—åˆ—è¡¨ -->
  <view class="favorites-list" wx:if="{{!empty && !loading}}">
    <!-- ç¼–è¾‘æ¨¡å¼é¡¶éƒ¨æ“ä½œæ  -->
    <view class="edit-toolbar" wx:if="{{editing}}">
      <view class="select-all" bindtap="toggleSelectAll">
        <view class="checkbox {{selectAll ? 'checked' : ''}}">
          <text class="check-icon" wx:if="{{selectAll}}">âœ“</text>
        </view>
        <text class="select-text">å…¨é€‰</text>
      </view>
      <view class="batch-actions">
        <text class="selected-count">å·²é€‰ {{selectedItems.length}} ä¸ª</text>
        <button class="delete-btn" bindtap="batchRemoveFavorites">åˆ é™¤</button>
      </view>
    </view>

    <!-- æ”¶è—å•†å“åˆ—è¡¨ -->
    <scroll-view 
      class="scroll-view" 
      scroll-y 
      enable-back-to-top
      bindscrolltolower="onReachBottom"
    >
      <view class="list-content">
        <view 
          class="favorite-item {{editing && selectedItems.indexOf(item.id) > -1 ? 'selected' : ''}}"
          wx:for="{{favorites}}" 
          wx:key="id"
          wx:for-index="index"
          wx:for-item="item"
        >
          <!-- é€‰æ‹©æ¡†ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
          <view 
            class="item-checkbox" 
            wx:if="{{editing}}"
            bindtap="toggleSelectItem"
            data-id="{{item.id}}"
          >
            <view class="checkbox {{selectedItems.indexOf(item.id) > -1 ? 'checked' : ''}}">
              <text class="check-icon" wx:if="{{selectedItems.indexOf(item.id) > -1}}">âœ“</text>
            </view>
          </view>

          <!-- å•†å“ä¿¡æ¯ -->
          <view 
            class="item-content" 
            bindtap="viewProductDetail"
            data-product="{{item}}"
          >
            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image">
              <image 
                class="image" 
                src="{{item.image || '/assets/images/default-food.png'}}" 
                mode="aspectFill"
              />
              <!-- å®‰å…¨çŠ¶æ€è§’æ ‡ -->
              <view class="safety-badge {{getSafetyColor(item.safetyStatus, item.riskLevel)}}">
                {{getSafetyTag(item.safetyStatus, item.riskLevel)}}
              </view>
            </view>

            <!-- å•†å“è¯¦æƒ… -->
            <view class="product-info">
              <view class="product-header">
                <text class="product-name" wx:if="{{item.name}}">{{item.name}}</text>
                <text class="product-name" wx:else>æœªçŸ¥å•†å“</text>
                <text class="product-barcode" wx:if="{{item.barcode}}">{{item.barcode}}</text>
              </view>

              <view class="product-details">
                <!-- åˆ¶é€ å•† -->
                <text class="detail-item" wx:if="{{item.manufacturer}}">
                  åˆ¶é€ å•†ï¼š{{item.manufacturer}}
                </text>
                <!-- æˆåˆ† -->
                <text class="detail-item ingredients" wx:if="{{item.ingredientList && item.ingredientList.length > 0}}">
                  æˆåˆ†ï¼š{{item.ingredientList.slice(0, 2).join('ã€')}}{{item.ingredientList.length > 2 ? '...' : ''}}
                </text>
                <!-- ä¿è´¨æœŸ -->
                <text class="detail-item" wx:if="{{item.shelfLife}}">
                  ä¿è´¨æœŸï¼š{{item.shelfLife}}
                </text>
              </view>

              <!-- é£é™©æç¤º -->
              <view class="risk-info" wx:if="{{item.riskMsg}}">
                <text class="risk-icon">âš ï¸</text>
                <text class="risk-text">{{item.riskMsg}}</text>
              </view>

              <!-- æ›´æ–°æ—¶é—´ -->
              <view class="update-time" wx:if="{{item.updateTime}}">
                <text class="time-icon">ğŸ•’</text>
                <text class="time-text">{{item.updateTime}}</text>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’®ï¼ˆéç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
            <view class="item-actions" wx:if="{{!editing}}">
              <button 
                class="remove-btn" 
                bindtap="removeFavorite"
                data-product="{{item}}"
              >
                å–æ¶ˆæ”¶è—
              </button>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view class="load-more" wx:if="{{hasMore}}">
          <text class="loading-text" wx:if="{{loadingMore}}">åŠ è½½ä¸­...</text>
          <text class="more-text" wx:else>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
        </view>

        <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
        <view class="no-more" wx:if="{{!hasMore && favorites.length > 0}}">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ”¶è—äº†</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
  <view class="bottom-toolbar" wx:if="{{editing && selectedItems.length > 0}}">
    <view class="toolbar-content">
      <text class="selected-info">å·²é€‰æ‹© {{selectedItems.length}} ä¸ªå•†å“</text>
      <button class="batch-delete-btn" bindtap="batchRemoveFavorites">åˆ é™¤</button>
    </view>
  </view>
</view>