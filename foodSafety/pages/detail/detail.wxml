<!-- pages/detail/detail.wxml -->
<view class="detail-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px">
    <view class="nav-left" bindtap="goBack">
      <icon type="back" size="24" color="#2c3e50" />
    </view>
    <text class="nav-title">æ£€æµ‹ç»“æœ</text>
    <view class="nav-right">
      <view class="nav-icon" bindtap="toggleFavorite">
        <icon 
          type="{{isFavorite ? 'star' : 'star-o'}}" 
          size="20" 
          color="{{isFavorite ? '#f1c40f' : '#2c3e50'}}" 
        />
      </view>
      <view class="nav-icon" bindtap="shareProduct">
        <icon type="share" size="20" color="#2c3e50" />
      </view>
    </view>
  </view>

  <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
  <scroll-view 
    class="scroll-content" 
    scroll-y 
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresh"
    bindscrolltolower="loadMore"
  >
    <!-- å•†å“å¡ç‰‡ -->
    <view class="product-card">
      <!-- å•†å“å›¾ç‰‡ -->
      <view class="product-image-container">
        <image 
          class="product-image" 
          src="{{product.image || '/assets/images/default-food.png'}}" 
          mode="aspectFill" 
          bindtap="previewImage"
        />
        <view class="image-badge">
          <view class="safety-badge {{product.safetyStatus === 'RISK' ? 'badge-danger' : 'badge-safe'}}">
            {{product.safetyStatus === 'RISK' ? 'æœ‰é£é™©' : 'å®‰å…¨'}}
          </view>
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="product-info">
        <text class="product-name">{{product.name || 'åŠ è½½ä¸­...'}}</text>
        
        <view class="product-meta">
          <view class="meta-item" wx:if="{{product.barcode}}">
            <icon type="barcode" size="14" color="#95a5a6" />
            <text>æ¡å½¢ç : {{product.barcode}}</text>
          </view>
          <view class="meta-item" wx:if="{{product.brand}}">
            <icon type="shop" size="14" color="#95a5a6" />
            <text>å“ç‰Œ: {{product.brand}}</text>
          </view>
          <view class="meta-item" wx:if="{{product.productionDate}}">
            <icon type="calendar" size="14" color="#95a5a6" />
            <text>ç”Ÿäº§æ—¥æœŸ: {{product.productionDate}}</text>
          </view>
          <view class="meta-item" wx:if="{{product.expireDate}}">
            <icon type="warning" size="14" color="#95a5a6" />
            <text>ä¿è´¨æœŸè‡³: {{product.expireDate}}</text>
          </view>
        </view>

        <!-- é£é™©ç­‰çº§ -->
        <view class="risk-level" wx:if="{{product.riskLevel > 0}}">
          <view class="level-header">
            <icon type="warn" size="16" color="#e74c3c" />
            <text class="level-title">é£é™©ç­‰çº§</text>
          </view>
          <view class="level-content">
            <view class="level-indicator">
              <view 
                class="level-bar {{product.riskLevel >= 1 ? 'active' : ''}} {{product.riskLevel === 1 ? 'current' : ''}}"
              >ä½</view>
              <view 
                class="level-bar {{product.riskLevel >= 2 ? 'active' : ''}} {{product.riskLevel === 2 ? 'current' : ''}}"
              >ä¸­</view>
              <view 
                class="level-bar {{product.riskLevel >= 3 ? 'active' : ''}} {{product.riskLevel === 3 ? 'current' : ''}}"
              >é«˜</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- é£é™©æç¤ºå¡ç‰‡ -->
    <view class="warning-card" wx:if="{{product.safetyStatus === 'RISK'}}">
      <view class="warning-header">
        <icon type="warn" size="20" color="#e74c3c" />
        <text class="warning-title">âš ï¸ é£é™©æç¤º</text>
      </view>
      <view class="warning-content">
        <text class="warning-message">{{product.riskMsg || 'æ£€æµ‹åˆ°é£é™©æˆåˆ†ï¼Œå»ºè®®è°¨æ…é£Ÿç”¨'}}</text>
        <view class="warning-tips">
          <text class="tip-item">â€¢ å»ºè®®å‡å°‘æ‘„å…¥é¢‘ç‡</text>
          <text class="tip-item">â€¢ ç‰¹æ®Šäººç¾¤ï¼ˆå„¿ç«¥ã€å­•å¦‡ï¼‰è¯·æ…ç”¨</text>
          <text class="tip-item">â€¢ æŸ¥çœ‹ä¸‹æ–¹æ›¿ä»£æ¨è</text>
        </view>
      </view>
    </view>

    <!-- é…æ–™åˆ†æ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title-line">
          <icon type="list" size="18" color="#2ecc71" />
          <text class="section-title">é…æ–™åˆ†æ</text>
        </view>
        <text class="section-count">
          å…± {{product.ingredientList ? product.ingredientList.length : 0}} ç§æˆåˆ†
        </text>
      </view>
      
      <view class="ingredients-container">
        <block wx:for="{{product.ingredientList}}" wx:key="index">
          <view class="ingredient-row" data-index="{{index}}" bindtap="showIngredientDetail">
            <view class="ingredient-main">
              <text class="ingredient-index">{{index + 1}}.</text>
              <text class="ingredient-name {{item.risk ? 'risk-name' : ''}}">
                {{item.name}}
              </text>
              <view class="ingredient-additive" wx:if="{{item.isAdditive}}">
                <text class="additive-tag">æ·»åŠ å‰‚</text>
              </view>
            </view>
            <view class="ingredient-tags">
              <view class="ingredient-tag {{getRiskTagClass(item)}}">
                {{getRiskTagText(item)}}
              </view>
              <view class="ingredient-tag allergen-tag" wx:if="{{isAllergen(item)}}">
                è¿‡æ•åŸ
              </view>
              <icon type="right" size="14" color="#ddd" />
            </view>
          </view>
          <view class="divider" wx:if="{{index < product.ingredientList.length - 1}}"></view>
        </block>
      </view>

      <!-- é£é™©æˆåˆ†ç»Ÿè®¡ -->
      <view class="risk-stats" wx:if="{{riskCount > 0}}">
        <view class="stat-item">
          <text class="stat-value">{{riskCount}}</text>
          <text class="stat-label">ä¸ªé£é™©æˆåˆ†</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{additiveCount}}</text>
          <text class="stat-label">ç§æ·»åŠ å‰‚</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{allergenCount}}</text>
          <text class="stat-label">ç§è¿‡æ•åŸ</text>
        </view>
      </view>
    </view>

    <!-- è¥å…»æˆåˆ† -->
    <view class="section-card" wx:if="{{product.nutrition && product.nutrition.length > 0}}">
      <view class="section-header">
        <view class="section-title-line">
          <icon type="filter" size="18" color="#2ecc71" />
          <text class="section-title">è¥å…»æˆåˆ† (æ¯100g)</text>
        </view>
        <text class="section-hint">NRV%: è¥å…»ç´ å‚è€ƒå€¼ç™¾åˆ†æ¯”</text>
      </view>
      
      <view class="nutrition-table">
        <view class="table-header">
          <text class="header-cell">è¥å…»æˆåˆ†</text>
          <text class="header-cell">å«é‡</text>
          <text class="header-cell">NRV%</text>
          <text class="header-cell">çŠ¶æ€</text>
        </view>
        
        <block wx:for="{{product.nutrition}}" wx:key="name">
          <view class="nutrition-row {{item.highlight ? 'highlight-row' : ''}}">
            <text class="nutrient-name">{{item.name}}</text>
            <text class="nutrient-value">{{item.value}}{{item.unit}}</text>
            <view class="nutrient-percent">
              <text class="percent-value">{{item.percent}}%</text>
              <view class="percent-bar">
                <view 
                  class="percent-fill {{item.percent > 100 ? 'over-limit' : ''}}"
                  style="width: {{Math.min(item.percent, 100)}}%"
                ></view>
              </view>
            </view>
            <view class="nutrient-status">
              <text class="status-text {{getNutritionStatus(item)}}">
                {{getNutritionStatusText(item)}}
              </text>
            </view>
          </view>
        </block>
      </view>
      
      <!-- è¥å…»æç¤º -->
      <view class="nutrition-tips">
        <text class="tip-title">ğŸ’¡ è¥å…»å°è´´å£«</text>
        <text class="tip-content">
          {{getNutritionTip()}}
        </text>
      </view>
    </view>

    <!-- ç±»ä¼¼äº§å“æ¨è -->
    <view class="section-card" wx:if="{{similarProducts.length > 0}}">
      <view class="section-header">
        <view class="section-title-line">
          <icon type="shop" size="18" color="#2ecc71" />
          <text class="section-title">å¥åº·æ›¿ä»£æ¨è</text>
        </view>
        <text class="section-hint">æ›´å®‰å…¨çš„åŒç±»äº§å“</text>
      </view>
      
      <scroll-view class="similar-list" scroll-x>
        <block wx:for="{{similarProducts}}" wx:key="id">
          <view class="similar-item" data-id="{{item.id}}" bindtap="viewSimilarProduct">
            <image class="similar-image" src="{{item.image}}" mode="aspectFill" />
            <view class="similar-info">
              <text class="similar-name">{{item.name}}</text>
              <view class="similar-safety safe-badge">
                <icon type="success" size="12" />
                <text>æ›´å®‰å…¨</text>
              </view>
              <view class="similar-reason">
                <text class="reason-text">{{item.reason}}</text>
              </view>
            </view>
          </view>
        </block>
      </scroll-view>
    </view>

    <!-- æ£€æµ‹ä¿¡æ¯ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title-line">
          <icon type="info" size="18" color="#2ecc71" />
          <text class="section-title">æ£€æµ‹ä¿¡æ¯</text>
        </view>
      </view>
      
      <view class="info-grid">
        <view class="info-item">
          <text class="info-label">æ£€æµ‹æ—¶é—´</text>
          <text class="info-value">{{product.updateTime || 'æœªçŸ¥'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ•°æ®æ¥æº</text>
          <text class="info-value">é£Ÿå“å®‰å…¨æ•°æ®åº“ v1.0</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ£€æµ‹ç‰ˆæœ¬</text>
          <text class="info-value">AIåˆ†æå¼•æ“ v2.1</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ›´æ–°å‘¨æœŸ</text>
          <text class="info-value">æ¯æœˆæ›´æ–°</text>
        </view>
      </view>
    </view>

    <!-- ç”¨æˆ·åé¦ˆ -->
    <view class="feedback-section">
      <text class="feedback-title">ä¿¡æ¯å‡†ç¡®å—ï¼Ÿ</text>
      <view class="feedback-buttons">
        <button 
          class="feedback-btn accurate" 
          data-type="accurate"
          bindtap="submitFeedback"
        >
          <icon type="success" size="14" />
          å‡†ç¡®
        </button>
        <button 
          class="feedback-btn inaccurate" 
          data-type="inaccurate"
          bindtap="submitFeedback"
        >
          <icon type="warn" size="14" />
          æœ‰è¯¯
        </button>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <view class="action-btn secondary" bindtap="addToShoppingList">
      <icon type="cart" size="18" />
      <text>åŠ å…¥æ¸…å•</text>
    </view>
    <view class="action-btn secondary" bindtap="checkSimilar">
      <icon type="search" size="18" />
      <text>æ‰¾æ›¿ä»£</text>
    </view>
    <view class="action-btn primary" bindtap="saveProduct">
      <icon type="star" size="18" />
      <text>{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
    </view>
  </view>

  <!-- åŠ è½½åŠ¨ç”» -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="spinner"></view>
      <text class="loading-text">æ­£åœ¨è·å–å•†å“ä¿¡æ¯...</text>
    </view>
  </view>

  <!-- é…æ–™è¯¦æƒ…å¼¹çª— -->
  <view class="ingredient-modal" wx:if="{{showIngredientModal}}">
    <view class="modal-mask" bindtap="closeIngredientModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é…æ–™è¯¦æƒ…</text>
        <icon 
          type="cancel" 
          size="20" 
          color="#95a5a6" 
          bindtap="closeIngredientModal"
        />
      </view>
      <scroll-view class="modal-body" scroll-y>
        <view class="ingredient-detail">
          <text class="detail-name">{{currentIngredient.name}}</text>
          <view class="detail-tags">
            <view class="detail-tag {{currentIngredient.risk ? 'risk-tag' : 'safe-tag'}}">
              {{currentIngredient.risk ? 'é£é™©æˆåˆ†' : 'å®‰å…¨æˆåˆ†'}}
            </view>
            <view class="detail-tag type-tag" wx:if="{{currentIngredient.type}}">
              {{currentIngredient.type}}
            </view>
          </view>
          <view class="detail-info">
            <text class="info-title">è¯´æ˜ï¼š</text>
            <text class="info-content">
              {{currentIngredient.description || 'æš‚æ— è¯¦ç»†è¯´æ˜'}}
            </text>
          </view>
          <view class="detail-risk" wx:if="{{currentIngredient.risk}}">
            <text class="risk-title">âš ï¸ é£é™©æç¤ºï¼š</text>
            <text class="risk-content">
              {{currentIngredient.riskInfo || 'é•¿æœŸè¿‡é‡æ‘„å…¥å¯èƒ½å¯¹å¥åº·é€ æˆå½±å“'}}
            </text>
          </view>
          <view class="detail-source">
            <text class="source-text">æ•°æ®æ¥æºï¼šå›½å®¶é£Ÿå“å®‰å…¨é£é™©è¯„ä¼°ä¸­å¿ƒ</text>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button class="modal-btn" bindtap="closeIngredientModal">çŸ¥é“äº†</button>
      </view>
    </view>
  </view>
</view>