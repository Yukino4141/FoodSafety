<!-- pages/index/index.wxml -->
<view class="index-page">
  
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <!-- <view class="status-bar" style="height: {{statusBarHeight}}px"></view> -->
  
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header">
    <!-- å·¦ä¾§ï¼šæ¬¢è¿è¯­/æ—¶é—´ -->
    <view class="header-left">
      <text class="greeting">
        <text wx:if="{{userInfo}}">{{userInfo.nickName}}ï¼Œ</text>
        ä¸‹åˆå¥½ï¼ğŸ‘‹
      </text>
      <text class="date-time">{{currentTime}}</text>
    </view>
    
    <!-- å³ä¾§ï¼šç”¨æˆ·å¤´åƒ/ç™»å½•æŒ‰é’® -->
    <view class="header-right" bindtap="goToProfile">
      <view class="avatar-container">
        <image 
          wx:if="{{userInfo && userInfo.avatarUrl}}" 
          src="{{userInfo.avatarUrl}}" 
          class="user-avatar"
        />
        <view wx:else class="user-avatar default">
          <text class="avatar-text">{{userInfo && userInfo.nickName ? userInfo.nickName.charAt(0) : '?'}}</text>
        </view>
        <view class="online-dot" wx:if="{{isLoggedIn}}"></view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å¡ç‰‡ -->
  <view class="search-card">
    <view class="card-content">
      <!-- æœç´¢æ¡† -->
      <view class="search-container" bindtap="onSearchClick">
        <view class="search-wrapper">
          <icon type="search" size="18" color="#2ecc71" class="search-icon" />
          <input 
            class="search-input"
            placeholder="æœç´¢é£Ÿå“åç§°ã€æ¡å½¢ç ..."
            placeholder-class="placeholder"
            value="{{searchKeyword}}"
            bindinput="onSearchInput"
            bindconfirm="onSearchConfirm"
            bindfocus="onSearchFocus"
            bindblur="onSearchBlur"
            confirm-type="search"
          />
        </view>
      </view>
    </view>
  </view>

  <!-- æ ¸å¿ƒåŠŸèƒ½åŒº -->
  <view class="core-section">
    <view class="section-title">
      <text class="title-text">æ ¸å¿ƒåŠŸèƒ½</text>
      <view class="title-decoration"></view>
    </view>
    
    <view class="scan-hero">
      <view class="scan-card" bindtap="handleScan">
        <!-- èƒŒæ™¯è£…é¥° -->
        <view class="scan-bg-decoration">
          <view class="circle circle-1"></view>
          <view class="circle circle-2"></view>
          <view class="circle circle-3"></view>
        </view>
        
        <!-- æ‰«ç æŒ‰é’® -->
        <view class="scan-main">
          <view class="scan-icon-container">
            <view class="scan-icon-bg">
              <image 
                src="/assets/icons/scan.png" 
                class="scan-icon"
                mode="aspectFit"
              />
              <view class="scan-pulse-ring"></view>
              <view class="scan-pulse-ring delay-1"></view>
              <view class="scan-pulse-ring delay-2"></view>
            </view>
          </view>
          
          <text class="scan-title">æ‰«ç æŸ¥æ¯’</text>
          <text class="scan-subtitle">å¿«é€Ÿæ£€æµ‹é£Ÿå“æ·»åŠ å‰‚é£é™©</text>
          
          <view class="scan-stats">
            <view class="stat-item">
              <text class="stat-number">{{stats.todayScan || 0}}</text>
              <text class="stat-label">ä»Šæ—¥æ£€æµ‹</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-number">{{stats.totalScan || 0}}</text>
              <text class="stat-label">ç´¯è®¡æ£€æµ‹</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-number">{{stats.riskCount || 0}}</text>
              <text class="stat-label">å‘ç°é£é™©</text>
            </view>
          </view>
        </view>
        
        <!-- æ‰«ææç¤º -->
        <view class="scan-tip">
          <icon type="info" size="14" color="#95a5a6" />
          <text class="tip-text">ç‚¹å‡»æ‰«æå•†å“æ¡å½¢ç </text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«æ·åŠŸèƒ½ -->
  <view class="quick-features">
    <view class="section-title">
      <text class="title-text">å¿«æ·åŠŸèƒ½</text>
      <view class="title-decoration"></view>
    </view>
    
    <view class="features-grid">
      <block wx:for="{{features}}" wx:key="id">
        <view 
          class="feature-card" 
          data-url="{{item.url}}" 
          bindtap="goToFeature"
          hover-class="card-hover"
          hover-stay-time="50"
        >
          <view class="feature-icon-container" style="background: {{item.color}}15;">
            <image src="{{item.icon}}" class="feature-icon" mode="aspectFit" />
            <view class="icon-badge" style="background: {{item.color}}"></view>
          </view>
          <view class="feature-content">
            <text class="feature-title">{{item.title}}</text>
            <text class="feature-desc">{{item.desc}}</text>
          </view>
          <icon type="right" size="16" color="#d1d5db" class="feature-arrow" />
        </view>
      </block>
    </view>
  </view>

  <!-- æœ€è¿‘æ‰«æè®°å½• -->
  <view class="recent-scans" wx:if="{{!historyEmpty && recentScans.length > 0}}">
    <view class="section-header">
      <view class="section-title">
        <text class="title-text">æœ€è¿‘æ‰«æ</text>
        <view class="title-decoration"></view>
      </view>
      <text class="see-all" bindtap="goToHistory">
        æŸ¥çœ‹å…¨éƒ¨
        <icon type="right" size="12" color="#2ecc71" />
      </text>
    </view>
    
    <scroll-view 
      class="recent-list" 
      scroll-x 
      scroll-with-animation 
      show-scrollbar="{{false}}"
    >
      <view class="recent-container">
        <block wx:for="{{recentScans}}" wx:key="id">
          <view 
            class="recent-card" 
            data-id="{{item.id}}"
            data-barcode="{{item.barcode}}"
            bindtap="viewDetail"
            bindlongpress="onItemLongPress"
            hover-class="card-hover"
          >
            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image-container">
              <image 
                src="{{item.image}}" 
                class="product-image" 
                mode="aspectFill"
                lazy-load
              />
              <!-- å®‰å…¨çŠ¶æ€å¾½ç«  -->
              <view class="safety-badge {{item.safetyStatus === 'RISK' ? 'badge-danger' : 'badge-safe'}}">
                <icon 
                  type="{{item.safetyStatus === 'RISK' ? 'warn' : 'success'}}" 
                  size="10" 
                  color="#ffffff" 
                />
                <text class="badge-text">
                  {{item.safetyStatus === 'RISK' ? 'æœ‰é£é™©' : 'å®‰å…¨'}}
                </text>
              </view>
              
              <!-- é£é™©æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ -->
              <view class="risk-hint" wx:if="{{item.safetyStatus === 'RISK' && item.riskMsg}}">
                <text class="hint-text">{{item.riskMsg}}</text>
              </view>
            </view>
            
            <!-- å•†å“ä¿¡æ¯ -->
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              
              <!-- æ—¶é—´ä¿¡æ¯ -->
              <view class="product-meta">
                <icon type="time" size="12" color="#9ca3af" />
                <text class="scan-time">{{item.scanTime}}</text>
              </view>
              
              <!-- æ¡å½¢ç  -->
              <view class="barcode-info" bindtap="copyBarcode" data-barcode="{{item.barcode}}">
                <icon type="barcode" size="12" color="#9ca3af" />
                <text class="barcode-text">æ¡å½¢ç : {{item.barcode}}</text>
                <icon type="copy" size="12" color="#9ca3af" class="copy-icon" />
              </view>
            </view>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="product-actions">
              <view class="action-btn share" catchtap="shareProduct" data-item="{{item}}">
                <icon type="share" size="14" color="#6b7280" />
              </view>
              <view class="action-btn delete" catchtap="deleteHistoryItem" data-item="{{item}}">
                <icon type="delete" size="14" color="#ef4444" />
              </view>
            </view>
          </view>
        </block>
        
        <!-- æŸ¥çœ‹æ›´å¤šå¡ç‰‡ -->
        <view class="view-more-card" bindtap="goToHistory">
          <view class="more-content">
            <icon type="more" size="24" color="#2ecc71" />
            <text class="more-text">æŸ¥çœ‹æ›´å¤š</text>
            <text class="more-count">{{stats.totalScan || 0}} æ¡è®°å½•</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{historyEmpty}}">
    <view class="empty-illustration">
      <image src="/assets/images/empty-scan.png" class="empty-image" mode="aspectFit" />
    </view>
    <text class="empty-title">æš‚æ— æ‰«æè®°å½•</text>
    <text class="empty-desc">å¼€å§‹æ‰«æç¬¬ä¸€ä¸ªå•†å“å§ï¼</text>
    <view class="empty-action" bindtap="handleScan">
      <text class="action-text">ç«‹å³æ‰«ç </text>
    </view>
  </view>

  <!-- åº•éƒ¨ä¿¡æ¯ -->
  <view class="footer">
    <view class="safety-tips">
      <icon type="safe" size="16" color="#2ecc71" />
      <text class="tips-text">é£Ÿå®‰å«å£«å·²å®ˆæŠ¤æ‚¨ {{stats.safeCount || 0}} æ¬¡å®‰å…¨æ¶ˆè´¹</text>
    </view>
    
    <view class="app-info">
      <text class="version">é£Ÿå®‰å«å£« v1.0</text>
      <text class="slogan">æ‰«ç è¯†é£é™©ï¼Œå®‰å¿ƒäº«ç¾é£Ÿ</text>
    </view>
  </view>

  <!-- æœç´¢å†å²å¼¹çª— -->
  <view class="search-history-modal" wx:if="{{showSearchHistory && searchHistory.length > 0}}">
    <view class="modal-mask" catchtap="onSearchBlur"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æœç´¢å†å²</text>
        <view class="header-actions">
          <text class="action-btn" bindtap="clearSearchHistory">æ¸…ç©º</text>
          <icon 
            type="cancel" 
            size="18" 
            color="#9ca3af" 
            bindtap="onSearchBlur"
            class="close-btn"
          />
        </view>
      </view>
      
      <view class="history-list">
        <block wx:for="{{searchHistory}}" wx:key="*this">
          <view 
            class="history-item" 
            data-keyword="{{item}}"
            bindtap="useSearchHistory"
          >
            <icon type="time" size="14" color="#9ca3af" />
            <text class="history-text">{{item}}</text>
            <icon type="right" size="14" color="#d1d5db" />
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- æ‰«ç åŠ è½½åŠ¨ç”» -->
  <view class="scan-loading" wx:if="{{scanning}}">
    <view class="loading-content">
      <view class="loading-spinner">
        <view class="spinner-ring"></view>
        <view class="spinner-ring delay-1"></view>
        <view class="spinner-ring delay-2"></view>
        <icon type="scan" size="32" color="#2ecc71" class="spinner-icon" />
      </view>
      <text class="loading-text">æ­£åœ¨å¯åŠ¨ç›¸æœº...</text>
      <text class="loading-tip">è¯·å¯¹å‡†å•†å“æ¡å½¢ç </text>
    </view>
  </view>

  <!-- ä¸‹æ‹‰åˆ·æ–°æç¤º -->
  <view class="refresh-indicator" wx:if="{{refreshing}}">
    <view class="refresh-spinner">
      <view class="refresh-dot"></view>
      <view class="refresh-dot"></view>
      <view class="refresh-dot"></view>
    </view>
    <text class="refresh-text">åˆ·æ–°ä¸­...</text>
  </view>
</view>