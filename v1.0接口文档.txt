é£Ÿå®‰å«å£« (Food Safety) V1.0 åç«¯æ¥å£æ–‡æ¡£


æ–‡æ¡£è¯´æ˜ï¼š
â— åŸºç¡€è·¯å¾„ï¼š
â—‹ ç®¡ç†ç«¯ï¼š/admin
â—‹ ç”¨æˆ·ç«¯ï¼š/user
â— æ•°æ®æ ¼å¼ï¼šapplication/json
â— ç»Ÿä¸€å“åº”ï¼šæ‰€æœ‰æ¥å£å‡è¿”å› com.itheima.common.result.Result<T> å¯¹è±¡ã€‚
JSON
{
"code": 1, // 1:æˆåŠŸ, 0:å¤±è´¥
"msg": "success", // é”™è¯¯æç¤ºä¿¡æ¯
"data": { ... } // å…·ä½“ä¸šåŠ¡æ•°æ®
}
â— é‰´æƒæ–¹å¼ï¼š
â—‹ ç®¡ç†ç«¯è¯·æ±‚å¤´ï¼štoken: [JWTå­—ç¬¦ä¸²]
â—‹ ç”¨æˆ·ç«¯è¯·æ±‚å¤´ï¼šauthentication: [JWTå­—ç¬¦ä¸²]


ğŸŸ¢ ç¬¬ä¸€éƒ¨åˆ†ï¼šç®¡ç†ç«¯æ¥å£ (Admin Controller)
Controller ç±»åï¼šAdminProductController / AdminEmployeeController

1. ç®¡ç†å‘˜ç™»å½•
â— æ¥å£æè¿°ï¼šå‘˜å·¥/ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿï¼Œè·å–æ“ä½œ Tokenã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/employee/login
â— è¯·æ±‚æ–¹å¼ï¼šPOST
â— è¯·æ±‚å‚æ•° (Body - EmployeeLoginDTO):
JSON
{
"username": "admin", // [å¿…å¡«] ç”¨æˆ·å
"password": "123" // [å¿…å¡«] å¯†ç  (æ˜æ–‡)
}
â— å“åº”æ•°æ® (Data - EmployeeLoginVO):
JSON
{
"id": 1,
"userName": "admin",
"name": "è¶…çº§ç®¡ç†å‘˜",
"token": "eyJhbGciOiJIUzI1Ni..." // åç»­è¯·æ±‚éœ€å¸¦ä¸Šæ­¤ Token
}
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: æ¥æ”¶ EmployeeLoginDTOï¼Œè°ƒç”¨ EmployeeService.loginã€‚
2. Service:
â–  è°ƒç”¨ EmployeeMapper.getByUsername(username)ã€‚
â–  åˆ¤æ–­è´¦å·æ˜¯å¦å­˜åœ¨ã€‚
â–  åˆ¤æ–­å¯†ç æ˜¯å¦åŒ¹é…ï¼ˆæ³¨æ„ï¼šå¦‚æœä½ å­˜çš„æ˜¯ MD5ï¼Œè¿™é‡Œè¦åŠ å¯†åæ¯”å¯¹ï¼‰ã€‚
â–  åˆ¤æ–­è´¦å·çŠ¶æ€ (status == 0 åˆ™æŠ›å‡ºâ€œè´¦å·å·²é”å®šâ€å¼‚å¸¸)ã€‚
â–  ç™»å½•æˆåŠŸï¼Œç”Ÿæˆ JWT ä»¤ç‰Œï¼Œå°è£…ä¸º EmployeeLoginVO è¿”å›ã€‚

2. å•†å“æ–°å¢ (Create)
â— æ¥å£æè¿°ï¼šå½•å…¥æ–°å•†å“ä¿¡æ¯ã€‚V1.0 æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºå»ºç«‹æ¼”ç¤ºæ•°æ®ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/product
â— è¯·æ±‚æ–¹å¼ï¼šPOST
â— è¯·æ±‚å¤´ï¼štoken: eyJ...
â— è¯·æ±‚å‚æ•° (Body - ProductDTO):
JSON
{
"barcode": "692000001", // [å¿…å¡«] æ¡å½¢ç 
"name": "æŸå“ç‰Œå¤¹å¿ƒé¥¼å¹²", // [å¿…å¡«] å•†å“åç§°
"image": "https://alioss...", // [é€‰å¡«] å›¾ç‰‡åœ°å€
"jsonIngredients": "å°éº¦ç²‰,ç™½ç ‚ç³–,ä»£å¯å¯è„‚" // [å¿…å¡«] é…æ–™å­—ç¬¦ä¸²ï¼Œé€—å·åˆ†éš”
}
â— å“åº”æ•°æ®ï¼šnull (æˆåŠŸä»…è¿”å› code=1)
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: æ¥æ”¶ ProductDTOï¼Œè°ƒç”¨ ProductService.saveã€‚
2. Service:
â–  å¯¹è±¡è½¬æ¢: å°† ProductDTO è½¬ä¸º Product å®ä½“ã€‚
â–  è‡ªåŠ¨å®šçº§é€»è¾‘: è·å– jsonIngredients å­—ç¬¦ä¸²ã€‚
â–  å®šä¹‰é»‘åå•åˆ—è¡¨: List<String> blacklist = Arrays.asList("ä»£å¯å¯è„‚", "åå¼è„‚è‚ª
é…¸", "è‹¯ç”²é…¸é’ ");
â–  éå†é»‘åå•ï¼Œå¦‚æœ jsonIngredients åŒ…å«ä»»æ„æ•æ„Ÿè¯ï¼Œè®¾ç½® riskLevel = 1 å¹¶ç”Ÿæˆ
riskMsgã€‚
â–  å¦åˆ™è®¾ç½® riskLevel = 0ã€‚
â–  è¡¥å……åŸºç¡€å­—æ®µï¼šcreateTime, updateTime, createUser (ä» ThreadLocal è·å–)ã€‚
â–  è°ƒç”¨ ProductMapper.insert(product)ã€‚

3. å•†å“åˆ†é¡µæŸ¥è¯¢ (Read - List)
â— æ¥å£æè¿°ï¼šç®¡ç†åå°å±•ç¤ºå•†å“åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰åç§°/æ¡ç æœç´¢ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/product/page
â— è¯·æ±‚æ–¹å¼ï¼šGET
â— è¯·æ±‚å¤´ï¼štoken: eyJ...
â— è¯·æ±‚å‚æ•° (Query - å¯¹åº” ProductPageQueryDTO):
â—‹ page: 1 (é¡µç )
â—‹ pageSize: 10 (æ¯é¡µæ¡æ•°)
â—‹ name: "é¥¼å¹²" (æ¨¡ç³Šæœç´¢ï¼Œé€‰å¡«)
â—‹ barcode: "692..." (ç²¾ç¡®æœç´¢ï¼Œé€‰å¡«)
â— å“åº”æ•°æ® (Data - PageResult):
JSON
{
"total": 50, // æ€»è®°å½•æ•°
"records": [ // å½“å‰é¡µæ•°æ®åˆ—è¡¨
{
"id": 101,
"barcode": "692000001",
"name": "æŸå“ç‰Œå¤¹å¿ƒé¥¼å¹²",
"image": "...",
"riskLevel": 1,
"updateTime": "2023-12-18 10:00:00"
},
...
]
}
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: æ¥æ”¶å‚æ•°ï¼Œè°ƒç”¨ ProductService.pageQueryã€‚
2. Service:
â–  ä½¿ç”¨ PageHelper.startPage(page, pageSize)ã€‚
â–  è°ƒç”¨ ProductMapper.pageQuery(dto)ã€‚
3. Mapper (XML):
â–  ç¼–å†™åŠ¨æ€ SQLï¼š<if test="name != null"> AND name LIKE concat('%',#{name},'%')
</if>ã€‚
4. Service: å°†æŸ¥è¯¢ç»“æœå°è£…ä¸º PageResult è¿”å›ã€‚

4. å•†å“ä¿®æ”¹ (Update)
â— æ¥å£æè¿°ï¼šä¿®æ”¹å•†å“ä¿¡æ¯ï¼ˆå¦‚ä¿®æ­£é…æ–™è¡¨ï¼‰ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/product
â— è¯·æ±‚æ–¹å¼ï¼šPUT
â— è¯·æ±‚å¤´ï¼štoken: eyJ...
â— è¯·æ±‚å‚æ•° (Body - ProductDTO):
JSON
{
"id": 101, // [å¿…å¡«] ä¿®æ”¹å“ªæ¡è®°å½•
"name": "ä¿®æ­£åçš„é¥¼å¹²å",
"jsonIngredients": "å°éº¦ç²‰,ç™½ç ‚ç³–", // ä¿®æ”¹é…æ–™
"image": "..."
}
â— å“åº”æ•°æ®ï¼šnull
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: è°ƒç”¨ ProductService.updateã€‚
2. Service:
â–  å°† ProductDTO è½¬ä¸º Product å®ä½“ã€‚
â–  é‡ç½®é£é™©ç­‰çº§ï¼šç”±äºä¿®æ”¹äº†é…æ–™è¡¨ï¼Œå¿…é¡»é‡æ–°æ‰§è¡Œâ€œè‡ªåŠ¨å®šçº§é€»è¾‘â€ï¼ˆåŒæ–°å¢æ¥å£ï¼‰ã€‚
â–  è®¾ç½® updateTimeã€‚
â–  è°ƒç”¨ ProductMapper.update(product)ã€‚

5. å•†å“åˆ é™¤ (Delete)
â— æ¥å£æè¿°ï¼šåˆ é™¤å½•å…¥é”™è¯¯çš„å•†å“ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/product
â— è¯·æ±‚æ–¹å¼ï¼šDELETE
â— è¯·æ±‚å¤´ï¼štoken: eyJ...
â— è¯·æ±‚å‚æ•° (Query):
â—‹ ids: "1,2,3" (æ”¯æŒæ‰¹é‡åˆ é™¤ï¼Œé€—å·åˆ†éš”çš„ ID å­—ç¬¦ä¸²)
â— å“åº”æ•°æ®ï¼šnull
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: æ¥æ”¶ List<Long> idsã€‚
2. Service: éå† ID æˆ–ä½¿ç”¨ IN æŸ¥è¯¢ã€‚
3. Mapper: DELETE FROM product WHERE id IN (...)ã€‚


ğŸ”µ ç¬¬äºŒéƒ¨åˆ†ï¼šç”¨æˆ·ç«¯æ¥å£ (User Controller)
Controller ç±»åï¼šUserProductController / UserController

1. å¾®ä¿¡ç™»å½•
â— æ¥å£æè¿°ï¼šCç«¯ç”¨æˆ·ä¸€é”®ç™»å½•ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/user/user/login
â— è¯·æ±‚æ–¹å¼ï¼šPOST
â— è¯·æ±‚å‚æ•° (Body - UserLoginDTO):
JSON
{
"code": "091h3...", // [å¿…å¡«] å¾®ä¿¡ wx.login è·å–çš„ä¸´æ—¶ç¥¨æ®
"userInfo": "..." // [é€‰å¡«] ç”¨äºæ›´æ–°å¤´åƒæ˜µç§°
}
â— å“åº”æ•°æ® (Data - UserLoginVO):
JSON
{
"id": 1001,
"openid": "ox9...",
"token": "eyJhbGciOiJIUzI1Ni..." // ç”¨æˆ·ç«¯ Token
}
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: è°ƒç”¨ UserService.wxLoginã€‚
2. Service:
â–  è°ƒç”¨ HttpClientUtil è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨ jscode2session æ¥å£ã€‚
â–  è§£æè¿”å›çš„ JSON è·å– openidã€‚
â–  æŸ¥åº“ï¼šUserMapper.getByOpenid(openid)ã€‚
â–  åˆ†æ”¯é€»è¾‘ï¼š
â–  è‹¥ä¸º nullï¼šUserMapper.insert(newUser) (è‡ªåŠ¨æ³¨å†Œ)ã€‚
â–  è‹¥å­˜åœ¨ï¼šè¿”å›ç”¨æˆ· IDã€‚
â–  ç”Ÿæˆ JWT ä»¤ç‰Œï¼Œå°è£… UserLoginVO è¿”å›ã€‚

2. æ‰«ç æŸ¥è¯¢è¯¦æƒ… (Read - Detail) [æ ¸å¿ƒæ¥å£]
â— æ¥å£æè¿°ï¼šç”¨æˆ·æ‰«ç åï¼ŒæŸ¥è¯¢å•†å“è¯¦æƒ…å¹¶å±•ç¤ºé£é™©åˆ†æç»“æœã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/user/product/scan/{barcode}
â— è¯·æ±‚æ–¹å¼ï¼šGET
â— è¯·æ±‚å¤´ï¼šauthentication: eyJ...
â— è¯·æ±‚å‚æ•° (Path Variable):
â—‹ barcode: "692000001" (æ¡å½¢ç )
â— å“åº”æ•°æ® (Data - ProductVO):
JSON
{
"id": 101,
"barcode": "692000001",
"name": "æŸå“ç‰Œå¤¹å¿ƒé¥¼å¹²",
"image": "http://...",
"ingredientList": ["å°éº¦ç²‰", "ç™½ç ‚ç³–", "ä»£å¯å¯è„‚"], // åç«¯å·²æ‹†åˆ†ä¸ºæ•°ç»„
"safetyStatus": "RISK", // å‰ç«¯æ®æ­¤æ˜¾ç¤ºã€çº¢è‰²ã€‘
"riskMsg": "å«ä»£å¯å¯è„‚ï¼Œå¯èƒ½å«æœ‰åå¼è„‚è‚ªé…¸", // è­¦ç¤ºæ–‡æ¡ˆ
"riskLevel": 1,
"updateTime": "..."
}
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: è°ƒç”¨ ProductService.scanByBarcodeã€‚
2. Service:
â–  è°ƒç”¨ ProductMapper.getByBarcode(barcode)ã€‚
â–  å¼‚å¸¸å¤„ç†ï¼šå¦‚æœè¿”å› nullï¼ŒæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ ProductNotFoundExceptionï¼ˆMsg: "å•†å“
æœªæ”¶å½•"ï¼‰ã€‚
â–  VO ç»„è£…ï¼š
â–  åˆ›å»º ProductVOã€‚
â–  BeanUtils æ‹·è´åŸºç¡€å±æ€§ã€‚
â–  é…æ–™è½¬æ¢ï¼šå°† jsonIngredients ("A,B,C") split ä¸º List<String> èµ‹å€¼ç»™
ingredientListã€‚
â–  çŠ¶æ€è½¬æ¢ï¼š
â–  å¦‚æœ riskLevel == 1 -> safetyStatus = "RISK"
â–  å¦‚æœ riskLevel == 0 -> safetyStatus = "SAFE"
â–  è®°å½•å†å²ï¼šå¼‚æ­¥è°ƒç”¨ ScanHistoryMapper.insertï¼Œè®°å½• userId å’Œ productIdã€‚
3. Return: è¿”å› ProductVOã€‚

3. å…³é”®è¯æœç´¢ (Read - List)
â— æ¥å£æè¿°ï¼šæ‰«ç å¤±è´¥æ—¶çš„å…œåº•æœç´¢ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/user/product/list
â— è¯·æ±‚æ–¹å¼ï¼šGET
â— è¯·æ±‚å¤´ï¼šauthentication: eyJ...
â— è¯·æ±‚å‚æ•° (Query):
â—‹ name: "è–¯ç‰‡"
â— å“åº”æ•°æ® (Data - List<ProductVO>):
JSON
[
{
"id": 102,
"name": "åŸå‘³è–¯ç‰‡",
"image": "...",
"safetyStatus": "SAFE", // åˆ—è¡¨é¡µä¹Ÿæ˜¾ç¤ºå®‰å…¨çŠ¶æ€
...
}
]
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: è°ƒç”¨ ProductService.searchListã€‚
2. Service:
â–  è°ƒç”¨ ProductMapper.listByName(name)ã€‚
â–  éå†ç»“æœé›†ï¼Œå°†æ¯ä¸ª Product è½¬ä¸º ProductVOï¼ˆåŒæ ·éœ€è¦å¤„ç† safetyStatus è½¬æ¢é€»
è¾‘ï¼‰ã€‚
3. Return: è¿”å› Listã€‚

4. é€šç”¨æ–‡ä»¶ä¸Šä¼  (Common)
â— æ¥å£æè¿°ï¼šä¸Šä¼ å›¾ç‰‡ï¼ˆå¦‚å•†å“å›¾ã€OCR æ‹ç…§å›¾ï¼‰ã€‚
â— è¯·æ±‚è·¯å¾„ï¼š/admin/common/upload (ç®¡ç†ç«¯ç”¨) æˆ– /user/common/upload (ç”¨æˆ·ç«¯ç”¨ï¼Œå¦‚æœå¼€
æ”¾ OCR)
â— è¯·æ±‚æ–¹å¼ï¼šPOST
â— è¯·æ±‚å‚æ•° (FormData):
â—‹ file: (äºŒè¿›åˆ¶æ–‡ä»¶)
â— å“åº”æ•°æ® (Data - String):
â—‹ è¿”å›å®Œæ•´çš„ OSS å›¾ç‰‡ URLã€‚
â— åç«¯å®ç°é€»è¾‘ï¼š
1. Controller: æ¥æ”¶ MultipartFile fileã€‚
2. Logic:
â–  ç”Ÿæˆ UUID æ–‡ä»¶åï¼Œé˜²æ­¢é‡åã€‚
â–  è°ƒç”¨ AliOssUtil.upload(file.getBytes(), fileName)ã€‚
3. Return: è¿”å› URL å­—ç¬¦ä¸²ã€‚


å¼€å‘é¡ºåºå»ºè®®
1. Pojo å±‚ï¼šå…ˆæŠŠç”¨æˆ·ç»™çš„ DTOã€VOã€Result ç±»å…¨éƒ¨æ”¾è¿›å»ã€‚
2. Mapper å±‚ï¼šå†™å¥½ ProductMapper çš„ XMLï¼Œç‰¹åˆ«æ˜¯åŠ¨æ€æŸ¥è¯¢å’Œæ ¹æ® Barcode æŸ¥è¯¢ã€‚
3. Service å±‚ï¼š
â—‹ å…ˆå†™ Admin ä¾§çš„â€œå¢åˆ æ”¹â€ï¼Œè¿™æ ·ä½ æ•°æ®åº“é‡Œæ‰æœ‰æ•°æ®ã€‚
â—‹ å†å†™ User ä¾§çš„â€œæ‰«ç æŸ¥è¯¢â€ï¼Œè¿™æ˜¯æ¼”ç¤ºçš„æ ¸å¿ƒã€‚
4. Controller å±‚ï¼šæŒ‰ç…§ä¸Šé¢çš„è·¯å¾„å’Œå‚æ•°ç»„è£…æ¥å£ã€‚
5. æµ‹è¯•ï¼šä½¿ç”¨ Apifox å…ˆè°ƒé€š Admin æ¥å£å½•å…¥å‡ ä¸ªæµ‹è¯•å•†å“ï¼Œå†è°ƒ User æ¥å£çœ‹èƒ½ä¸èƒ½æŸ¥åˆ°ã€‚